# 마우스 휠 줌 이슈 기록

- 날짜: 2025-09-09
- 범위: `src/canvas/CanvasStage.tsx`, `src/App.tsx`
- 관련 문서: `docs/task/mouse_scroll_functionality.md`

## 배경

원본 PySide 앱은 슬롯 위에서의 휠 스크롤이 해당 슬롯 이미지에만 적용되도록 동작한다. 웹 전환(React + Konva) 과정에서 동일 UX(포인터 기준 줌, 슬롯 단위 적용)를 구현하는 작업 중 다음 문제가 발생했다.

## 증상

- 슬롯 이미지 드래그가 되지 않거나 간헐적으로만 동작
- 스크롤 로그는 남지만 실제 이미지는 확대/축소가 반영되지 않음
- 특정 레이아웃(예: `2컷 세로`)에서 스크롤 시 이미지가 화면 모서리로 튀거나 시야 밖으로 사라짐
- 콘솔 경고: `Konva warning: NaN is not a valid value for "x"|"y"` 등 수치값 NaN 관련 경고

## 근본 원인(Root Cause)

1) 이벤트 가로채기 오버레이
- 슬롯 전체에서 휠을 받기 위해 이미지 위에 투명 `Rect`를 오버레이로 추가했는데, 이 레이어가 드래그/클릭 이벤트를 가로채 드래그가 불가능해짐.

2) 상태 업데이트만 의존한 렌더 반영 지연
- 휠 핸들러가 `onImageTransform`을 통해 상태만 갱신하고 실제 Konva 노드를 즉시 갱신하지 않았다. React 상태 갱신 타이밍(비동기)과 합쳐져 프레임 내 시각 변화가 보이지 않거나, 콜백 전달 경로에 따라 갱신이 누락되는 케이스가 발생.

3) 포인터 기준 보정 및 경계 클램프 미흡
- 스케일 변경 시 포인터 기준 위치 보정이 누락되어 이미지가 슬롯 모서리로 순간이동하는 현상.
- 슬롯 경계로의 x/y 클램프 미흡으로 스케일/이동 후 시야 밖으로 사라짐.

4) 숫자 안전성 결여
- 드래그/스케일 중간값에서 NaN이 전파되어 Konva 경고를 유발. 수치 가드가 충분하지 않았음.

## 해결 방안(Implementations)

1) 이벤트 레이어 정리
- 이미지 위 오버레이 `Rect` 제거로 드래그 회귀 해결.
- 대신 슬롯 그룹 내부에서 이미지 "아래"에 투명 `Rect`를 배치해 빈 영역에서도 휠/클릭을 전달(이미지는 그대로 드래그 가능).

2) 포인터 기준 줌 구현 및 즉시 반영
- 스테이지 스케일을 반영해 포인터 좌표(px, py)를 캔버스 좌표계로 환산.
- `local = (pointer - imagePos) / oldScale`로 로컬 좌표를 구하고, `imagePos' = pointer - local * newScale`로 새 위치 계산.
- 슬롯 경계로 x/y 클램프 후, Konva 이미지 노드를 즉시 `scaleX/scaleY/position`으로 갱신하고 `batchDraw()` 호출.
- 동시에 `onImageTransform`을 통해 상태에도 반영(리렌더 보장). 방어적으로 부모 콜백을 한 번 더 직접 호출.

3) 숫자 가드 및 범위 제한
- `Number.isFinite`로 `x, y, scaleX, scaleY, rotation` 가드, 비정상 값은 기본값(0, 1, 0)으로 보정.
- 스케일 클램프 범위 `0.1 ~ 3.0` 적용.

4) 디버그 로그 추가
- `[wheel] start/selecting/scales/newScale/pointer/nextTransform/dispatch/applied` 단계별 로깅.
- `[App] onImageTransform` 및 `[render] image { sx, sy, x, y }`로 상태→렌더 경로 추적.

## 검증 결과

- `2컷 세로` 상단 슬롯에서 대용량 PNG(2667×4000, 15MB) 테스트 기준:
  - 이미지 위·빈 영역 모두 스크롤로 포인터 기준 줌 정상 동작
  - 드래그 정상 동작, 슬롯 경계 내에서 제한
  - 콘솔 NaN 경고 제거됨
  - 렌더 로그의 `sx/sy`가 스크롤과 함께 변동 확인

## 회고 / 베스트 프랙티스

- Konva와 React를 함께 사용할 때, 입력 이벤트에 따른 "즉시 시각 피드백"은 Konva 노드 직접 갱신으로 보완하고, 상태는 동기화 용도로 별도 반영하는 이중 경로가 안정적이다.
- 상위 캡처 오버레이는 인터랙션을 쉽게 망가뜨리므로, 필요한 경우 Z-Order를 조정하거나 "아래쪽 백그라운드 캡처"로 대체한다.
- 좌표/스케일 계산에는 스테이지 스케일과 슬롯 경계(클리핑 영역)를 반드시 포함해 튀는 현상을 방지한다.
- 수치 연산 전후 `Number.isFinite` 가드는 필수. 제한 범위를 일관되게 적용한다.

## 변경 파일

- `src/canvas/CanvasStage.tsx`
  - 포인터 기준 줌 계산 및 경계 클램프
  - Konva 이미지 노드 즉시 갱신 + 상태 업데이트 동시 수행
  - 오버레이 레이어 제거 및 백그라운드 캡처 레이어 추가
  - NaN 가드 및 상세 디버그 로그 추가
- `src/App.tsx`
  - `onImageTransform` 디버그 로그 추가

## 후속 작업 후보

- `scaleBy`(기본 1.1) 및 스케일 범위 사용자 환경에 맞춘 조정 옵션화
- 휠 감도/트랙패드 제스처에 대한 이질감 최소화를 위한 플랫폼별 튜닝
- E2E 테스트(Playwright)로 슬롯별 줌/드래그 상호작용 회귀 방지

