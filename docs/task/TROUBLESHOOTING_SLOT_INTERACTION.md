# 슬롯 상호작용 문제 해결 지침

본 문서는 슬롯 영역에서의 드래그(이미지 이동) 및 마우스 휠 스크롤(줌/스크롤) 중 발생하는 상호작용 문제를 재현·진단·해결하기 위한 가이드입니다. 다음 두 상황을 대상으로 합니다.

- 상황 A: 업로드된 이미지를 슬롯 안에서 드래그할 때 비정상 동작
- 상황 B: 슬롯 위에 커서를 올린 채 스크롤(휠/트랙패드)할 때 비정상 동작

프로젝트 구조 기준 경로 표기:

- 스테이지/캔버스: `src/canvas/*`
- UI 오버레이/사이드바: `src/ui/*`
- 상태/스토어: `src/state/*`
- 단위 변환/좌표계: `src/utils/*`, 파이썬 코어: `editor_core/*`

## 1) 증상 정의 및 기대 동작

### 상황 A: 슬롯 내 이미지 드래그
- 증상 예시
  - 이미지가 튀거나 지연/가속되어 손가락(커서)과 분리됨
  - 드래그 중 의도치 않은 페이지 스크롤/줌 발생
  - 드래그가 슬롯 경계 밖으로 허용되거나, 반대로 경계 내부에서도 움직임이 막힘
  - 드래그가 간헐적으로 취소되거나 선택이 해제됨(포인터 캡처 상실)
- 기대 동작
  - 커서(포인터) 이동에 부드럽게 추종, 프레임 드랍 없이 렌더
  - 슬롯 경계 내에서만 이동, 경계에 닿으면 자연스럽게 클램프(clamp)
  - 드래그 중 페이지 스크롤/줌, 텍스트 선택 등 브라우저 기본 동작 차단

### 상황 B: 슬롯 위 휠/트랙패드 스크롤
- 증상 예시
  - 의도하지 않은 브라우저 페이지 스크롤 발생(스테이지가 아닌 문서가 스크롤)
  - 줌/팬이 과도하거나 델타가 비정상적(맥 트랙패드에서 과민/둔감)
  - 슬롯 오버레이가 휠 이벤트를 가로채 캔버스에 전달되지 않음
- 기대 동작(정책에 따라 1개 선택 및 일관 적용)
  - 정책 1: 슬롯/스테이지 위 휠 = 캔버스 줌/팬, 문서 스크롤 방지
  - 정책 2: 슬롯/스테이지 위 휠 = 문서 스크롤 유지(줌/팬은 별도 제스처)

정책은 UI/UX 명세에 따라 하나만 채택해 일관되게 적용합니다.

## 2) 빠른 체크리스트(우선 점검)

1. 이벤트 수집 계층 정리
   - 드래그/휠 처리 대상 노드가 단일한가?(`src/canvas/*` 루트 레이어 권장)
   - 오버레이(`src/ui/*`)가 포인터/휠 이벤트를 가로채지 않는가?
2. 브라우저 기본 동작 차단
   - 드래그/휠 처리 중 `preventDefault()`가 누락되지 않았는가?
   - 휠/터치 리스너가 `passive: false`로 등록되었는가? (필요 시)
3. 포인터 캡처 라이프사이کل
   - `pointerdown -> setPointerCapture -> pointermove -> pointerup/cancel -> release`
   - 캡처 누락/중복/조기 해제로 이동이 끊기지 않는가?
4. 좌표계/단위 일관성
   - `world <-> stage <-> screen` 변환, `mm <-> px`, `devicePixelRatio` 적용이 일관적인가?
   - CSS `transform: scale()`과 내부 줌 변수를 혼용하지 않는가?
5. 경계 처리
   - 슬롯 바운딩 박스가 올바른 좌표계 기준으로 계산·클램프 되는가?
6. 스크롤 컨테이너 설정
   - 캔버스 컨테이너에 `overscroll-behavior: contain`(또는 `none`)이 설정되어 문서 스크롤 누출을 막는가?
7. 델타 정규화
   - `WheelEvent.deltaMode`(pixel/line/page) 차이를 정규화하는가?
   - 트랙패드/마우스 휠 환경에서 과민/둔감 보정이 있는가?

## 3) 원인별 진단 가이드

### 3.1 브라우저 기본 드래그/스크롤 간섭
- 징후: 드래그 중 파란 하이라이트, 커서가 금지/복사 아이콘으로 바뀜, 페이지가 스크롤됨
- 점검
  - HTML5 Drag & Drop API가 암묵적으로 발동되지 않도록, 캔버스/이미지 엘리먼트에서 네이티브 드래그를 억제했는지 확인
  - 드래그/휠 처리 구간에서 `event.preventDefault()` 호출 경로가 보장되는지 확인
  - 휠/터치 리스너 등록 시 `passive: false`가 필요한 지점에 누락되지 않았는지 확인
- 권장 대응
  - 포인터 이벤트 기반 커스텀 드래그만 허용(HTML5 dragstart 방지)
  - 스테이지 루트에서 스크롤·텍스트 선택 억제 스타일/속성 적용

### 3.2 포인터 캡처 누락으로 인한 이동 끊김
- 징후: 드래그가 간헐 중단, 경계 근처에서 놓침, 다른 레이어로 포인터가 넘어가며 취소
- 점검
  - `pointerdown` 시점에 `event.target.setPointerCapture(event.pointerId)`를 호출하는지
  - `pointerup/pointercancel`에서만 `releasePointerCapture`를 호출하는지
  - 멀티 터치/펜 입력 혼합 시 pointerId가 교체되거나 중복 해제되지 않는지

### 3.3 좌표계/스케일 변환 오류
- 징후: 커서와 이미지가 평행 이동하지 않음, 줌 레벨에 따라 오차 변동
- 점검
  - `getBoundingClientRect()` 기준 스크린 좌표를 스테이지/월드 좌표로 정확히 변환하는지
  - `devicePixelRatio`, 내부 줌 스케일, CSS transform 중복 적용 여부
  - `mm <-> px` 변환이 `src/utils/*`/`editor_core/*` 정의와 일관성 유지되는지
- 권장 대응
  - 단일한 좌표 변환 유틸을 경유하도록 강제(혼용 금지)
  - 렌더 루프당 1회만 바운딩/스케일 값을 계산, 이벤트 핫패스에서 재계산 최소화

### 3.4 슬롯 바운딩/히트테스트 불일치
- 징후: 경계 밖 이동 허용, 경계 내부에서도 충돌로 막힘
- 점검
  - 슬롯 바운딩이 스테이지(월드) 좌표 기준으로 계산되는지
  - 리사이즈/줌 시 바운딩 캐시 갱신이 누락되지 않았는지
  - 마스크/클리핑 경계와 논리 경계가 동일한지
- 권장 대응
  - 이동 적용 전후로 클램프: `pos = clamp(pos, slot_min, slot_max)`
  - 바운딩 계산-적용 좌표계가 동일한지 단위 테스트 추가(추후)

### 3.5 오버레이/레이어가 이벤트를 가로채는 문제
- 징후: 슬롯 위에서 휠이 동작하지 않거나 드래그가 간헐 취소
- 점검
  - 오버레이 DOM에 `pointer-events` 설정이 적절한지(`none`/`auto` 케이스 구분)
  - 상위 스크롤 컨테이너가 휠 이벤트를 먼저 소비하는지
- 권장 대응
  - 인터랙션 비대상 오버레이는 `pointer-events: none`
  - 상위 컨테이너에 `overscroll-behavior: contain` 적용

### 3.6 휠 델타 정규화 미흡
- 징후: 브라우저/OS마다 줌/팬 속도가 들쭉날쭉
- 점검
  - `deltaMode`가 `DOM_DELTA_LINE(1)`/`DOM_DELTA_PIXEL(0)`/`DOM_DELTA_PAGE(2)` 중 무엇인지 분기 처리 여부
  - 맥 트랙패드의 고해상도 델타에 대한 스케일링/클램프 유무
- 권장 대응
  - 픽셀 단위로 정규화 후 공통 스케일 팩터 적용, 최소/최대 속도 클램프
  - `requestAnimationFrame` 기반 배치 업데이트로 과도한 리렌더 방지

## 4) 단계별 해결 절차(권장 워크플로)

1) 재현 시나리오 고정
   - 줌 레벨, 브라우저, 입력 장치(마우스/트랙패드), 템플릿(2/4/6/9컷)을 고정하여 재현

2) 이벤트 경로 가시화(로그/오버레이)
   - 포인터 다운/무브/업, 캡처 상태, 휠 델타/모드, `preventDefault` 호출 여부를 콘솔 로그로 확인
   - 슬롯/스테이지 바운딩을 시각화(디버그 오버레이)하여 좌표계 오차 추적

3) 정책 결정 및 단일화
   - 휠 정책(줌/팬 vs 문서 스크롤)을 결정하고, 반대 동작은 전역적으로 억제

4) 핫패스 정비
   - 포인터 캡처 엄격 적용, 브라우저 기본 드래그/선택 억제
   - 휠 리스너 passive 설정 점검(`passive: false` 필요 지점 확인)
   - 델타 정규화 및 rAF 배치 반영

5) 좌표/경계 정합성 확보
   - 단일 변환 유틸을 경유하여 `screen -> stage -> world` 변환
   - 슬롯 경계 계산과 이동 클램프가 동일 좌표계 기준으로 일치하는지 검증

6) 컨테이너/오버레이 보정
   - `overscroll-behavior` 적용으로 문서 스크롤 누출 방지
   - 비대상 오버레이 `pointer-events: none`

7) 성능/프레임 검증
   - 60fps 유지 여부, 이벤트 처리 시간, 레이아웃 스래싱 유무 측정(Performance 패널)

## 5) 모듈 경로별 점검 포인트

- `src/canvas/*`
  - 포인터/휠 이벤트의 단일 진입점 확보
  - 좌표 변환 유틸 일원화, CSS transform 의존 제거
  - 렌더 루프 내 바운딩/스케일 캐시 처리

- `src/ui/*`
  - 오버레이의 `pointer-events` 역할 명확화
  - 스테이지 상호작용과 충돌하는 핸들러 제거 또는 위임

- `src/state/*`
  - 드래그/줌/팬 상태머신 정리(진입/이행/종료 이벤트 명시)
  - 포인터 캡처/취소 시 상태 정합성 유지

- `src/utils/*`, `editor_core/*`
  - `mm <-> px`, DPI, 스케일 팩터 일관성 검증
  - 정밀도 손실(부동소수 누적) 최소화를 위한 공용 래퍼 제공

## 6) 수용 기준(AC)

- 드래그 시 커서와 이미지 위치 오차 ≤ 1px(동일 프레임 기준)
- 슬롯 경계 밖 이동 불가, 경계에서 미세 떨림 없음
- 슬롯/스테이지 위 휠 입력 정책이 일관되게 적용되고 문서 스크롤 누출 없음
- 마우스 휠/트랙패드 모두에서 줌/팬 속도 일관, 과민/둔감 없음
- 60fps에 준하는 인터랙션 프레임 유지(중간 수준 콘텐츠 기준)

## 7) 회귀 방지(권장 테스트)

- 시나리오
  - 템플릿(2/4/6/9컷) × 브라우저(Chrome/Safari/Firefox) × 입력(마우스/트랙패드)
  - 서로 다른 줌 레벨(0.5×, 1×, 2×)에서 드래그/휠 동작 확인
- 자동화(향후)
  - 포인터/휠 이벤트 시뮬레이션 기반 상호작용 스냅샷 테스트
  - 좌표 변환/경계 클램프 유닛 테스트(델타·스케일 매개변수화)

## 8) 체크리스트 요약(현장용)

- [ ] 스테이지 단일 이벤트 진입점 확보(오버레이 간섭 제거)
- [ ] 드래그/휠 중 `preventDefault` 적용, 필요한 리스너 `passive: false`
- [ ] 포인터 캡처 라이프사이클 정합성
- [ ] `screen-stage-world` 좌표 변환 단일화, CSS transform 혼용 금지
- [ ] 슬롯 경계 계산 좌표계 통일, 이동 클램프 적용
- [ ] `overscroll-behavior`로 문서 스크롤 누출 차단
- [ ] 휠 델타 정규화(rAF 배치, 스케일/클램프)
- [ ] 60fps 성능 확인(Performance 프로파일)

## 9) 알려진 제약/주의

- 일부 브라우저/OS 조합에서 트랙패드 델타가 과도하게 세밀할 수 있으므로 상·하한 클램프가 필요합니다.
- 고DPI 디스플레이에서 `devicePixelRatio` 변동(창 이동 등)에 따라 렌더 스케일 재계산이 필요합니다.
- 스크린 리더/접근성 고려 시, 기본 스크롤 억제는 문서 전체 접근성에 영향을 줄 수 있으므로 범위를 최소화하세요.

---

담당: Canvas/Interaction 소유자. 정책 변경 시 `docs/`의 상호작용 사양과 동기화하세요.

